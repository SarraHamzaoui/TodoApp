name: CI - Tests, Coverage, Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:

  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build project
        run: mvn clean install -DskipTests=true
        working-directory: TodoBackend/TodoApp

      - name: Run Tests
        run: mvn test
        working-directory: TodoBackend/TodoApp

      - name: Generate Surefire HTML report
        run: mvn surefire-report:report
        working-directory: TodoBackend/TodoApp

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: TodoBackend/TodoApp/target/site/surefire-report.html

      - name: Upload JaCoCo Coverage
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: TodoBackend/TodoApp/target/site/jacoco/


  zap_scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # üöÄ 1) Lancer ton backend Spring
      - name: Start Spring Boot app
        run: |
          mvn spring-boot:run &
          sleep 15
        working-directory: TodoBackend/TodoApp

      # üîí 2) ZAP Baseline Scan
      - name: Run ZAP Baseline Scan
        id: zap
        uses: zaproxy/action-baseline@v0.11.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://localhost:8089"   # ‚¨ÖÔ∏è MET LE PORT DE TON BACKEND !
          cmd_options: "-r zap_report.html"

      # üìÅ 3) Upload du rapport
      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap_report.html
          if-no-files-found: error
