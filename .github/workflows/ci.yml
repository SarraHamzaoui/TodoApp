name: ZAP Baseline Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- START THE APP ----------
      - name: Start Spring Boot App
        run: |
          echo "Lancement de l'app..."
          nohup ./mvnw spring-boot:run &
          sleep 20
          echo "App should be running"

      # ---------- CREATE WRITABLE DIR ----------
      - name: Create ZAP workspace
        run: |
          mkdir zap-wrk
          chmod -R 777 zap-wrk
          ls -lah

      # ---------- RUN ZAP ----------
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://localhost:8089"
          rules_file_name: ""
          cmd_options: "-r zap_report.html"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------- UPLOAD REPORT ----------
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap_report.html
          if-no-files-found: warn
