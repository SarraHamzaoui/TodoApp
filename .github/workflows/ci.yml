security-scan:
  runs-on: ubuntu-latest
  needs: build-and-test

  permissions:
    contents: read
    actions: write
    security-events: write

  services:
    mysql:
      image: mysql:8
      env:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: tododb
      ports:
        - 3306:3306
      options: >-
        --health-cmd="mysqladmin ping --silent"
        --health-interval=5s
        --health-timeout=2s
        --health-retries=20

  steps:
    - name: ‚öôÔ∏è Checkout repository
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: üöÄ Start Spring Boot (background) via JAR
      working-directory: TodoBackend/TodoApp
      run: |
        JAR_FILE=$(ls target/*.jar | head -n 1)
        if [ -z "$JAR_FILE" ]; then
          echo "Error: JAR file not found in target/. Aborting scan."
          exit 1
        fi

        nohup java -jar $JAR_FILE \
          --server.port=8089 \
          --spring.datasource.url="jdbc:mysql://localhost:3306/tododb" \
          --spring.datasource.username=root \
          --spring.datasource.password=root > springboot.log 2>&1 &

        echo "Waiting 45 seconds for server startup..."
        sleep 45
        tail -n 30 springboot.log

    - name: ‚è≥ Wait for App to be Responsive
      run: |
        for i in {1..10}; do
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:8089/auth/login | grep -q '40'; then
            echo "App is responsive"
            break
          fi
          sleep 5
        done

    - name: üë§ Register Scan User
      run: |
        curl -s -X POST http://localhost:8089/auth/register \
          -H "Content-Type: application/json" \
          -d '{"email":"scanuser@zap.com","password":"zap-password"}' || true

    - name: üîë Get JWT token
      id: get-token
      run: |
        RESPONSE=$(curl -s -X POST http://localhost:8089/auth/login \
          -H "Content-Type: application/json" \
          -d '{"email":"scanuser@zap.com","password":"zap-password"}')
        TOKEN=$(echo "$RESPONSE" | jq -r '.token')
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "ERROR: Failed to get JWT token"
          echo "$RESPONSE"
          exit 1
        fi
        echo "TOKEN=$TOKEN" >> $GITHUB_ENV

    - name: üõ°Ô∏è Run OWASP ZAP Baseline Scan (HTML report)
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:8089'
        docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
        cmd_options: '-a -r /github/workspace/zap-report.html'

    - name: üìù Upload ZAP HTML Report (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: zap-security-report
        path: ./zap-report.html
